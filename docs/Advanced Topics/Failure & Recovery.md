第32章 故障和恢复
---
JanusGraph是一个高度可用且强大的图形数据库。在大规模的JanusGraph部署失败是不可避免的。本页介绍了一些失败情况以及JanusGraph如何处理它们。

### 32.1 事务失败
事务失败的原因有很多。如果事务在提交之前失败，那么更改将被丢弃，应用程序可以根据业务逻辑重试事务。同样，锁或其他一致性失败将在持久性之前导致异常，因此可以重试。事务的持久性阶段是JanusGraph开始将数据持久化到各种后端系统的时候。

JanusGraph首先将所有图形变化持久化到存储后端。此持久性作为批处理变化执行，以确保对支持原子性的后端以原子方式提交该变化。如果批处理更改由于存储后端中的异常而失败，则整个事务失败。

但是，这可能与索引和日志不一致。为了自动修复这些不一致，JanusGraph可以通过维护配置启用的事务预写日志。
```
tx.log -tx = true
tx.max-commit-time = 10000
```
max-commit-time属性用于确定事务何时失败。如果事务的持久性阶段花费的时间超过此时间，JanusGraph将在必要时尝试恢复它。因此，应该将此超时配置为持久性最大持续时间的上限。注意，这并不包括提交之前花费的时间。

此外，必须设置一个单独的进程来读取日志，以识别部分失败的事务并修复导致的任何不一致。建议在连接到集群的单独机器上运行事务修复过程，以隔离故障。配置一个单独控制的进程来运行以下操作:开始时间指定从epoch开始恢复进程开始从写前日志读取的时间。
```
recovery = JanusGraphFactory.startTransactionRecovery(graph, startTime, TimeUnit.MILLISECONDS);
```
启用事务预写日志会导致对事务进行额外的写操作，从而增加延迟。另请注意，存储日志需要额外的空间。事务预写日志具有2天的可配置生存时间，这意味着日志条目在该时间之后到期以保持较小的存储开销。有关用于微调日志记录行为的所有日志相关配置选项的完整列表，请参阅第15章，配置参考。
### 32.2 JanusGraph实例失败

JanusGraph对于单个实例失败是健壮的，因为JanusGraph集群的其他实例不受此类失败的影响，并且在重新启动失败的实例时可以继续处理事务而不会损失性能。

然而，一些模式相关的操作(如安装索引)需要协调所有JanusGraph实例。因此，JanusGraph维护所有运行实例的记录。如果一个实例失败，即没有正确地关闭，JanusGraph会认为它是活动的，并期望它参与集群范围的操作，这些操作随后会失败，因为该实例没有参与或没有确认操作。

在这种情况下，用户必须手动从集群中删除失败的实例记录，然后重试操作。要删除失败的实例，请对任何正在运行的JanusGraph实例打开一个管理事务，检查正在运行的实例列表，以识别失败的实例，最后删除它。

```
mgmt = graph.openManagement()
mgmt.getOpenInstances() //all open instances
==>7f0001016161-dunwich1(current)
==>7f0001016161-atlantis1
mgmt.forceCloseInstance('7f0001016161-atlantis1') //remove an instance
mgmt.commit()
```
当前JanusGraph实例的惟一标识符是用后缀(current)标记的，以便于容易识别。这个实例不能通过forceCloseInstance方法关闭，而是应该通过g.close()关闭。

必须确保手动删除的实例确实不再活动。从集群中删除一个活动的JanusGraph实例可能会导致数据不一致。因此，特别当JanusGraph在实例自动重启的环境中操作时，请小心使用此方法。
